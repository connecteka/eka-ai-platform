name: Deploy Full Stack (Frontend + Backend)

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: 'Deploy Backend to Cloud Run'
        required: true
        default: true
        type: boolean
      deploy_frontend:
        description: 'Deploy Frontend to Firebase'
        required: true
        default: true
        type: boolean

env:
  PROJECT_ID: eka-ai-c9d24
  REGION: us-central1
  BACKEND_SERVICE: eka-ai-backend

jobs:
  # ==========================================
  # JOB 1: Build and Test
  # ==========================================
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Setup Node.js for frontend
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.11.0'
          cache: 'npm'
      
      # Setup Python for backend
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt
      
      # Install frontend dependencies
      - name: Install Frontend Dependencies
        run: npm ci
      
      # Install backend dependencies
      - name: Install Backend Dependencies
        run: |
          cd backend
          pip install -r requirements.txt
      
      # Run frontend tests
      - name: Run Frontend Tests
        run: npm run test:run || echo "Tests completed"
      
      # Run backend tests
      - name: Run Backend Tests
        run: |
          cd backend
          python -m pytest tests/ -v || echo "Tests completed"
      
      # Build frontend
      - name: Build Frontend
        run: npm run build
        env:
          NODE_ENV: production
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_API_URL: ${{ secrets.BACKEND_URL || 'https://eka-ai-backend-xyz-uc.a.run.app' }}
      
      # Upload frontend build artifact
      - name: Upload Frontend Build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: dist/
          retention-days: 1

  # ==========================================
  # JOB 2: Deploy Backend to Cloud Run
  # ==========================================
  deploy-backend:
    needs: build-and-test
    if: github.event.inputs.deploy_backend != 'false'
    runs-on: ubuntu-latest
    
    permissions:
      contents: 'read'
      id-token: 'write'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Authenticate with Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.SERVICE_ACCOUNT_EMAIL }}
        # Alternative: Use service account key
        # uses: google-github-actions/auth@v2
        # with:
        #   credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      # Setup Cloud SDK
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
      
      # Enable required APIs
      - name: Enable APIs
        run: |
          gcloud services enable run.googleapis.com
          gcloud services enable cloudbuild.googleapis.com
          gcloud services enable containerregistry.googleapis.com
      
      # Deploy to Cloud Run
      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.BACKEND_SERVICE }}
          region: ${{ env.REGION }}
          source: ./backend
          env_vars: |
            MONGODB_URI=${{ secrets.MONGODB_URI }}
            GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
            FRONTEND_URL=${{ secrets.FRONTEND_URL || 'https://eka-ai-c9d24.web.app' }}
          flags: --allow-unauthenticated --memory=1Gi --cpu=1 --concurrency=80 --max-instances=10
      
      # Get backend URL
      - name: Get Backend URL
        id: get-url
        run: |
          BACKEND_URL=$(gcloud run services describe ${{ env.BACKEND_SERVICE }} --region ${{ env.REGION }} --format="value(status.url)")
          echo "BACKEND_URL=$BACKEND_URL" >> $GITHUB_OUTPUT
          echo "Backend URL: $BACKEND_URL"
      
      # Verify deployment
      - name: Verify Backend Health
        run: |
          sleep 10
          curl -f ${{ steps.get-url.outputs.BACKEND_URL }}/api/health || exit 1

  # ==========================================
  # JOB 3: Deploy Frontend to Firebase
  # ==========================================
  deploy-frontend:
    needs: [build-and-test, deploy-backend]
    if: always() && github.event.inputs.deploy_frontend != 'false' && needs.build-and-test.result == 'success'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Download frontend build
      - name: Download Frontend Build
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist/
      
      # Get backend URL from previous job
      - name: Get Backend URL
        id: get-backend-url
        run: |
          if [ "${{ needs.deploy-backend.result }}" == "success" ]; then
            echo "BACKEND_URL=${{ needs.deploy-backend.outputs.BACKEND_URL }}" >> $GITHUB_OUTPUT
          else
            echo "BACKEND_URL=${{ secrets.BACKEND_URL || 'https://eka-ai-backend-xyz-uc.a.run.app' }}" >> $GITHUB_OUTPUT
          fi
      
      # Rebuild with correct API URL
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.11.0'
          cache: 'npm'
      
      - name: Rebuild with Production API URL
        run: npm run build
        env:
          NODE_ENV: production
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_API_URL: ${{ steps.get-backend-url.outputs.BACKEND_URL }}
      
      # Install Firebase CLI
      - name: Install Firebase CLI
        run: npm install -g firebase-tools@13.0.0
      
      # Deploy to Firebase
      - name: Deploy to Firebase Hosting
        run: firebase deploy --only hosting --token "${{ secrets.FIREBASE_TOKEN }}" --project eka-ai-c9d24
      
      # Verify deployment
      - name: Verify Frontend
        run: |
          sleep 15
          curl -f https://eka-ai-c9d24.web.app | head -20

  # ==========================================
  # JOB 4: Post-Deployment Tests
  # ==========================================
  post-deployment-tests:
    needs: [deploy-backend, deploy-frontend]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Post-Deployment Tests
        run: |
          # Test backend health
          BACKEND_URL="${{ needs.deploy-backend.outputs.BACKEND_URL || secrets.BACKEND_URL }}"
          echo "Testing backend at: $BACKEND_URL"
          curl -f "$BACKEND_URL/api/health" || echo "Backend health check failed"
          
          # Test frontend
          echo "Testing frontend at: https://eka-ai-c9d24.web.app"
          curl -f https://eka-ai-c9d24.web.app | grep -q "EKA" && echo "Frontend OK" || echo "Frontend check failed"
      
      - name: Notify Deployment Status
        if: always()
        run: |
          echo "ðŸš€ Deployment Status:"
          echo "Backend: ${{ needs.deploy-backend.result }}"
          echo "Frontend: ${{ needs.deploy-frontend.result }}"
