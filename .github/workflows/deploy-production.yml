name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deployment_target:
        description: 'Deployment Target'
        required: true
        default: 'railway'
        type: choice
        options:
          - railway
          - gcp-cloudrun

env:
  NODE_ENV: production
  VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
  VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
  VITE_API_URL: ${{ secrets.VITE_API_URL || 'https://api.eka-ai.in' }}

jobs:
  # ==================== TEST ====================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run tests
        run: npm run test:run

  # ==================== BUILD FRONTEND ====================
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build frontend
        run: npm run build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: dist/
          retention-days: 1

  # ==================== DEPLOY FRONTEND TO FIREBASE ====================
  deploy-frontend:
    name: Deploy Frontend to Firebase
    runs-on: ubuntu-latest
    needs: build-frontend
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist/
      
      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          channelId: live
          projectId: eka-ai-platform

  # ==================== DEPLOY BACKEND TO RAILWAY ====================
  deploy-backend-railway:
    name: Deploy Backend to Railway
    runs-on: ubuntu-latest
    needs: test
    if: github.event.inputs.deployment_target == 'railway' || github.event.inputs.deployment_target == null
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install Railway CLI
        run: npm install -g @railway/cli
      
      - name: Set Railway Environment Variables
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          cd backend
          railway link --project eka-ai-platform
          # Set environment variables from secrets
          railway variables set \
            SUPABASE_URL="${{ secrets.VITE_SUPABASE_URL }}" \
            SUPABASE_KEY="${{ secrets.VITE_SUPABASE_ANON_KEY }}" \
            SUPABASE_SERVICE_KEY="${{ secrets.VITE_SUPABASE_ANON_KEY }}" \
            MONGO_URL="${{ secrets.MONGO_URL }}" \
            MONGODB_DATABASE="eka_ai" \
            GEMINI_API_KEY="${{ secrets.GEMINI_KEY }}" \
            JWT_SECRET="${{ secrets.JWT_SECRET }}" \
            ALLOWED_ORIGINS="https://www.eka-ai.in,https://app.eka-ai.in" \
            NODE_ENV="production" \
            ENVIRONMENT="production" \
            ENABLE_RATE_LIMITING="true" \
            ENABLE_CACHING="true" \
            ENABLE_MONITORING="true"
      
      - name: Deploy to Railway
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          cd backend
          railway up --detach
      
      - name: Verify deployment
        run: |
          echo "‚è≥ Waiting for deployment to be ready..."
          sleep 30
          curl -f https://api.eka-ai.in/health || echo "‚ö†Ô∏è Health check failed - check Railway logs"

  # ==================== DEPLOY BACKEND TO CLOUD RUN (Fallback) ====================
  deploy-backend-gcp:
    name: Deploy Backend to GCP Cloud Run
    runs-on: ubuntu-latest
    needs: test
    if: github.event.inputs.deployment_target == 'gcp-cloudrun'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: named-dialect-486912-c7
          service_account_key: ${{ secrets.GCP_SA_KEY }}
      
      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy eka-ai-backend \
            --source ./backend \
            --platform managed \
            --region asia-south1 \
            --allow-unauthenticated \
            --set-env-vars="SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }},SUPABASE_KEY=${{ secrets.VITE_SUPABASE_ANON_KEY }},MONGO_URL=${{ secrets.MONGO_URL }},JWT_SECRET=${{ secrets.JWT_SECRET }},GEMINI_API_KEY=${{ secrets.GEMINI_KEY }}" \
            --memory 512Mi \
            --max-instances 10 \
            --quiet
      
      - name: Get backend URL
        run: |
          echo "Backend URL:"
          gcloud run services describe eka-ai-backend --region asia-south1 --format 'value(status.url)'

  # ==================== NOTIFICATION ====================
  notify:
    name: Deployment Complete
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend-railway]
    if: always() && (needs.deploy-backend-railway.result == 'success' || needs.deploy-backend-railway.result == 'skipped')
    
    steps:
      - name: Check deployment status
        run: |
          echo "‚úÖ Frontend deployed to Firebase"
          if [ "${{ needs.deploy-backend-railway.result }}" == "success" ]; then
            echo "‚úÖ Backend deployed to Railway: https://api.eka-ai.in"
          elif [ "${{ needs.deploy-backend-railway.result }}" == "skipped" ]; then
            echo "‚ÑπÔ∏è Railway deployment skipped"
          fi
          echo ""
          echo "üìã Next Steps:"
          echo "  1. Verify health: curl https://api.eka-ai.in/health"
          echo "  2. Run load tests: ./scripts/run-load-tests.sh https://api.eka-ai.in"
          echo "  3. Check Railway dashboard for metrics"
